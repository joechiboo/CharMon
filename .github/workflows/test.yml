name: ğŸ§ª æ¸¬è©¦æµç¨‹

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    name: ğŸ”¬ å–®å…ƒæ¸¬è©¦
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: charmon-app/package-lock.json

      - name: ğŸ“‹ å®‰è£å‰ç«¯ä¾è³´
        run: |
          cd charmon-app
          rm -rf node_modules package-lock.json
          npm install

      - name: ğŸ”§ é¡å‹æª¢æŸ¥
        run: |
          cd charmon-app
          npm run type-check

      - name: ğŸ§¹ ç¨‹å¼ç¢¼æª¢æŸ¥
        run: |
          cd charmon-app
          npm run lint

      - name: ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦
        run: |
          cd charmon-app
          npm run test:unit

  backend-tests:
    name: ğŸš€ å¾Œç«¯æ¸¬è©¦
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: charmon-backend/package-lock.json

      - name: ğŸ“‹ å®‰è£å¾Œç«¯ä¾è³´
        run: |
          cd charmon-backend
          rm -rf node_modules package-lock.json
          npm install

      - name: ğŸ”§ TypeScript ç·¨è­¯æª¢æŸ¥
        run: |
          cd charmon-backend
          npm run build

      - name: ğŸš€ å•Ÿå‹•å¾Œç«¯æœå‹™ (èƒŒæ™¯)
        run: |
          cd charmon-backend
          npm run dev &
          sleep 10

      - name: ğŸ©º API å¥åº·æª¢æŸ¥
        run: |
          curl -f http://localhost:3001/api/pokemon/health || exit 1
          curl -f http://localhost:3001/api/pokemon/status || exit 1

  e2e-tests:
    name: ğŸ­ ç«¯åˆ°ç«¯æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: [unit-tests, backend-tests]

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“‹ å®‰è£å‰ç«¯ä¾è³´
        run: |
          cd charmon-app
          rm -rf node_modules package-lock.json
          npm install

      - name: ğŸ“‹ å®‰è£å¾Œç«¯ä¾è³´
        run: |
          cd charmon-backend
          rm -rf node_modules package-lock.json
          npm install

      - name: ğŸ­ å®‰è£ Playwright
        run: |
          cd charmon-app
          npx playwright install --with-deps

      - name: ğŸš€ å•Ÿå‹•å¾Œç«¯æœå‹™
        run: |
          cd charmon-backend
          npm run dev &
          sleep 15

      - name: ğŸ¬ åŸ·è¡Œ E2E æ¸¬è©¦
        run: |
          cd charmon-app
          npm run test:e2e

      - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: charmon-app/playwright-report/
          retention-days: 30

      - name: ğŸ“ˆ ä¸Šå‚³æ¸¬è©¦çµæœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: charmon-app/test-results/
          retention-days: 30

  build-test:
    name: ğŸ—ï¸ æ§‹å»ºæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: charmon-app/package-lock.json

      - name: ğŸ“‹ å®‰è£ä¾è³´
        run: |
          cd charmon-app
          rm -rf node_modules package-lock.json
          npm install

      - name: ğŸ—ï¸ æ§‹å»ºç”Ÿç”¢ç‰ˆæœ¬
        run: |
          cd charmon-app
          npm run build

      - name: ğŸ“¦ ä¸Šå‚³æ§‹å»ºç”¢ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: charmon-app/dist/

  security-scan:
    name: ğŸ”’ å®‰å…¨æƒæ
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” å®‰å…¨æ¼æ´æƒæ (å‰ç«¯)
        run: |
          cd charmon-app
          npm audit --audit-level high

      - name: ğŸ” å®‰å…¨æ¼æ´æƒæ (å¾Œç«¯)
        run: |
          cd charmon-backend
          npm audit --audit-level high